---
title: 'Fine-tuning a Huggingface Model Using Own Data'
date: 2022-02-20
permalink: /posts/2020/02/blog-post-1/
tags:

---

This is my first blog about how to use huggingface models.

Headings are cool
======

# This is the introduction of the official paper dataset.

### Created by Lutz, thanks for Jack's help.


```python
import pickle
with open('paper_official_dict.pkl', 'rb') as f:
    data = pickle.load(f)
```


```python
# import numpy as np
# import matplotlib as mpl
# import matplotlib.pyplot as plt
```

In this data set, there are totally three categories.


```python
data.keys()
```




    dict_keys(['dx', 'total', 'y'])



'y' key is a pandas data frame, with 93039 rows × 38 columns. Each column represents a CPT code, and each row represents one corpus text.


```python
type(data['y'])
```




    pandas.core.frame.DataFrame




```python
print(data['y'])
```

           85060   85097   87491   87591   87624   88108   88112   88141   88142   \
    0           0       0       0       0       0       0       0       0       0   
    1           0       0       0       0       0       0       0       0       0   
    2           0       0       0       0       0       0       0       0       0   
    3           0       0       0       0       0       0       0       0       0   
    4           0       0       0       0       0       0       0       0       0   
    ...       ...     ...     ...     ...     ...     ...     ...     ...     ...   
    96413       0       0       0       0       0       0       0       0       0   
    96414       0       0       0       0       0       0       0       0       0   
    96415       0       0       0       0       0       0       0       0       0   
    96416       0       0       0       0       0       0       0       0       0   
    96417       0       0       0       0       0       0       0       0       0   
    
           88172   ...  88321   88331   88332   88333   88341   88342   88344   \
    0           0  ...       0       0       0       0       0       0       0   
    1           0  ...       0       0       0       0       0       0       0   
    2           0  ...       0       0       0       0       0       0       0   
    3           0  ...       0       0       0       0       0       1       0   
    4           0  ...       0       0       0       0       0       0       0   
    ...       ...  ...     ...     ...     ...     ...     ...     ...     ...   
    96413       1  ...       0       0       0       0       0       0       0   
    96414       0  ...       0       0       0       0       0       0       0   
    96415       0  ...       0       0       0       0       1       1       0   
    96416       0  ...       0       0       0       0       0       0       0   
    96417       0  ...       0       0       0       0       0       1       0   
    
           88346   88350   88360   
    0           0       0       0  
    1           0       0       0  
    2           0       0       0  
    3           0       0       0  
    4           0       0       0  
    ...       ...     ...     ...  
    96413       0       0       0  
    96414       0       0       0  
    96415       0       0       0  
    96416       0       0       0  
    96417       0       0       0  
    
    [93039 rows x 38 columns]


'dx' key is a python dictionary. There are 4 keys in this 'dx' category, which are 'count_mat', 'words', 'X', 't_data'


```python
type(data['dx'])
```




    dict




```python
data['dx']
```




    {'count_mat': <93039x27944 sparse matrix of type '<class 'numpy.int64'>'
        with 3194062 stored elements in Compressed Sparse Row format>,
     'words': array(['aah', 'ab', 'abdomen', ..., 'zygoma shave', 'zygomatic',
            'zygomatic cheek'], dtype='<U40'),
     'X': 0      skin right mid cheek shave biopsy residual des...
     1      skin vertex scalp shave biopsy lentiginous com...
     2      a skin right neck shave biopsy basal cell carc...
     3      skin right infraorbital fold punch biopsy soli...
     4      skin lower mid back shave removal basal cell c...
                                  ...                        
     477                                           discussion
     478    a duodenum biopsy duodenal mucosa with foveola...
     479    bladder tumor transurethral resection poorly d...
     480    sigmoid colon polypectomy tubular adenoma and ...
     481    skin distal right shaft of penis snip invasive...
     Name: DIAGNOSIS, Length: 93039, dtype: object,
     't_data': array([[ 5.0043659e+00,  5.0391936e+00,  1.9079094e+00,  8.0926542e+00,
             -2.6625404e-01,  7.0883365e+00],
            [ 3.1006806e+00,  5.9415464e+00,  9.6853966e-01,  7.5504012e+00,
             -9.8909959e-03,  9.7989922e+00],
            [ 5.1250415e+00,  5.5251012e+00,  5.2665768e+00,  2.9125879e+00,
             -1.6631803e-01,  6.4141183e+00],
            ...,
            [ 3.9591911e+00,  3.0206673e+00,  3.1558347e+00,  7.7240958e+00,
              3.4549477e+00,  7.0087657e+00],
            [ 8.1379251e+00,  3.2363911e+00,  3.0830288e+00,  7.2528691e+00,
              6.4924130e+00,  5.5804157e+00],
            [ 1.0914077e+01,  4.6742506e+00, -8.4830296e-01,  5.8695946e+00,
              2.5420270e+00,  1.0069085e+01]], dtype=float32)}




```python
data['dx'].keys()
```




    dict_keys(['count_mat', 'words', 'X', 't_data'])



For the 'count_mat' and 'words', 'words' is a numpy array, with lenth 27944. It's the total vocabulary in the corpus. And the count_mat is a large matrix, each row represents one corpus text. Each column represents a word appears in the total vocabulary. This is why this matrix is 93039 by 27944


```python
type(data['dx']['count_mat'])
```




    scipy.sparse.csr.csr_matrix




```python
data['dx']['count_mat']
```




    <93039x27944 sparse matrix of type '<class 'numpy.int64'>'
        with 3194062 stored elements in Compressed Sparse Row format>




```python
type(data['dx']['words'])
```




    numpy.ndarray




```python
len(data['dx']['words'])
```




    27944



The 'X' is the corpus text data. Length is 93039. They are diagnosis, which are same as the diagnosis in the 'total' key


```python
type(data['dx']['X'])
```




    pandas.core.series.Series




```python
len(data['dx']['X'])
```




    93039




```python
for i in data['dx']['X'][:10]:
    print(i)
```

    skin right mid cheek shave biopsy residual desmoplastic trichoepithelioma and scar consistent with prior surgical procedure the margins are clear in t hese sections comment cr
    skin vertex scalp shave biopsy lentiginous compound dysplastic nevus with mild moderate atypia and congenital features extending to the peripheral a nd deep specimen edges cr
    a skin right neck shave biopsy basal cell carcinoma nodular type focally pigmented present at the base of the biopsy specimen with overlying ver rucous squamous hyperplasia b skin right shoulder shave biopsy basal cell carcinoma with sclerosing features and infiltrating growth pattern present at the peripheral and deep specimen edge focally pigmented focal dermal fibrosis suggestive of prior trauma or procedure cr
    skin right infraorbital fold punch biopsy solitary dendritic melanocytes and dermal melanophages sparse perifolliculitis with a perivascular lymphocytic infiltrate and telangiectasias comment cr
    skin lower mid back shave removal basal cell carcinoma nodular type and pigmented cr
    a skin vertex of scalp shave biopsy basal cell carcinoma b skin right lateral upper arm shave biopsy at least squamous cell carcinoma in situ bowen 's disease present at the peripheral and deep specimen edges invasi ve squamous cell carcinoma can not be excluded c skin central upper chest shave biopsy basal cell carcinoma with infiltrating growth pattern present at the peripheral and deep specimen edges cr
    specimen inappropriate for leukemia/lymphoma screen due to high rbc count see comment
    skin right medial thigh punch biopsy spongiosis dermal eosinophils see comment cr
    skin mm above an imaginary horizontal line between the eyebrows just left of midline shave biopsy basal cell carcinoma involving biopsy edges cr
    skin right breast shave removal compound dysplastic melanocytic nevus with moderate atypia extending to one specimen edge see comment cr


For the last key, 'total' is a python dictionary.


```python
type(data['total'])
```




    dict



There are 4 cateories in 'total', which are 'count_mat', 'words', 'X' and 't_data'


```python
data['total']
```




    {'count_mat': <93039x103260 sparse matrix of type '<class 'numpy.int64'>'
        with 17812889 stored elements in Compressed Sparse Row format>,
     'words': array(['aa', 'aa exon', 'aaa', ..., 'zygomatic arch', 'zygomatic cheek',
            'zygomatic shave'], dtype='<U40'),
     'X':                                   CLINICAL INFORMATION  \
     0    specimen submitted a skin right mid cheek shav...   
     1    specimen submitted a skin vertex scalp shave b...   
     2    specimen submitted a skin rt neck shave b skin...   
     3    specimen submitted a r infraorbital fold mm pu...   
     4    specimen submitted a skin lower mid back shave...   
     ..                                                 ...   
     477  specimen source peripancreatic region of infla...   
     478  specimen submitted a duodenum bx 's grossly no...   
     479  specimen submitted a bladder tumor clinical hi...   
     480  specimen submitted a sigmoid polyps clinical h...   
     481  specimen submitted a skin distal right shaft o...   
     
                                        SPECIMEN PROCESSING  \
     0    a labeled/fixative right midcheek formalin qua...   
     1    a labeled/fixative patient 's information form...   
     2    a labeled/fixative r. neck formalin quantity/s...   
     3    a labeled/fixative patient 's name formalin qu...   
     4    a labeled/fixative patient demographics formal...   
     ..                                                 ...   
     477                                                NaN   
     478  a labeled/fixative duodenum biopsies grossly n...   
     479  a labeled/fixative bladder tumor fresh quantit...   
     480  a labeled/fixative sigmoid polyps formalin qua...   
     481  a labeled/fixative patient demographics formal...   
     
                                                  DIAGNOSIS  \
     0    skin right mid cheek shave biopsy residual des...   
     1    skin vertex scalp shave biopsy lentiginous com...   
     2    a skin right neck shave biopsy basal cell carc...   
     3    skin right infraorbital fold punch biopsy soli...   
     4    skin lower mid back shave removal basal cell c...   
     ..                                                 ...   
     477                                         discussion   
     478  a duodenum biopsy duodenal mucosa with foveola...   
     479  bladder tumor transurethral resection poorly d...   
     480  sigmoid colon polypectomy tubular adenoma and ...   
     481  skin distal right shaft of penis snip invasive...   
     
                                                 DISCUSSION  \
     0    this case has been reviewed by drs yan and lin...   
     1                                                  NaN   
     2                                                  NaN   
     3    the underlying etiology of the clinical pigmen...   
     4                                                  NaN   
     ..                                                 ...   
     477                                                NaN   
     478                                                NaN   
     479  the tumor demonstrates small nests and discohe...   
     480                                                NaN   
     481  consensus diagnosis was established among derm...   
     
                                         ADDITIONAL STUDIES ADDENDUM DISCUSSION  \
     0                                                  NaN                 NaN   
     1                                                  NaN                 NaN   
     2                                                  NaN                 NaN   
     3    immunohistochemistry studies formalin fixed pa...                 NaN   
     4                                                  NaN                 NaN   
     ..                                                 ...                 ...   
     477                                                NaN                 NaN   
     478                                                NaN                 NaN   
     479  immunohistochemistry studies formalin fixed pa...                 NaN   
     480                                                NaN                 NaN   
     481  multiple step leveled sections are reviewed me...                 NaN   
     
         RESULTS INTERPRETATION FROZEN SECTION FINAL DIAGNOSIS  \
     0       NaN            NaN            NaN             NaN   
     1       NaN            NaN            NaN             NaN   
     2       NaN            NaN            NaN             NaN   
     3       NaN            NaN            NaN             NaN   
     4       NaN            NaN            NaN             NaN   
     ..      ...            ...            ...             ...   
     477     NaN            NaN            NaN             NaN   
     478     NaN            NaN            NaN             NaN   
     479     NaN            NaN            NaN             NaN   
     480     NaN            NaN            NaN             NaN   
     481     NaN            NaN            NaN             NaN   
     
         FROZEN SECTION DIAGNOSIS  
     0                        NaN  
     1                        NaN  
     2                        NaN  
     3                        NaN  
     4                        NaN  
     ..                       ...  
     477                      NaN  
     478                      NaN  
     479                      NaN  
     480                      NaN  
     481                      NaN  
     
     [93039 rows x 11 columns],
     't_data': array([[ 8.9735775 ,  6.4404483 ,  1.8068712 ,  5.1054926 ,  4.220717  ,
              7.234646  ],
            [ 8.471797  ,  4.598076  ,  7.4370384 ,  0.97371113,  8.947324  ,
              5.6192756 ],
            [ 7.891263  ,  9.393927  ,  7.0306997 ,  9.532352  ,  8.116953  ,
              5.7252307 ],
            ...,
            [10.255065  ,  6.8390937 ,  5.34078   ,  7.951117  , -0.80052   ,
              4.5998387 ],
            [10.446472  ,  4.8934393 ,  9.275722  ,  5.9878325 ,  3.5733078 ,
              4.656906  ],
            [10.545345  , 10.835133  ,  4.2757154 ,  2.905858  ,  3.2086627 ,
              6.6211905 ]], dtype=float32)}




```python
data['total'].keys()
```




    dict_keys(['count_mat', 'words', 'X', 't_data'])



The 'count_mat' and 'words' are similar with those under 'dx'

'words' is the total vocabulary list, contains every word appears in the corpus text

'count_mat' is the large sparse matrix, each row represents one corpus text. Each column represents a word appears in the total vocabulary. And the matrix is 93039 by 103260

The 'X' is a pandas data frame. It's 93039 rows × 11 columns


```python
type(data['total']['X'])
```




    pandas.core.frame.DataFrame




```python
print(data['total']['X'])
```

                                      CLINICAL INFORMATION  \
    0    specimen submitted a skin right mid cheek shav...   
    1    specimen submitted a skin vertex scalp shave b...   
    2    specimen submitted a skin rt neck shave b skin...   
    3    specimen submitted a r infraorbital fold mm pu...   
    4    specimen submitted a skin lower mid back shave...   
    ..                                                 ...   
    477  specimen source peripancreatic region of infla...   
    478  specimen submitted a duodenum bx 's grossly no...   
    479  specimen submitted a bladder tumor clinical hi...   
    480  specimen submitted a sigmoid polyps clinical h...   
    481  specimen submitted a skin distal right shaft o...   
    
                                       SPECIMEN PROCESSING  \
    0    a labeled/fixative right midcheek formalin qua...   
    1    a labeled/fixative patient 's information form...   
    2    a labeled/fixative r. neck formalin quantity/s...   
    3    a labeled/fixative patient 's name formalin qu...   
    4    a labeled/fixative patient demographics formal...   
    ..                                                 ...   
    477                                                NaN   
    478  a labeled/fixative duodenum biopsies grossly n...   
    479  a labeled/fixative bladder tumor fresh quantit...   
    480  a labeled/fixative sigmoid polyps formalin qua...   
    481  a labeled/fixative patient demographics formal...   
    
                                                 DIAGNOSIS  \
    0    skin right mid cheek shave biopsy residual des...   
    1    skin vertex scalp shave biopsy lentiginous com...   
    2    a skin right neck shave biopsy basal cell carc...   
    3    skin right infraorbital fold punch biopsy soli...   
    4    skin lower mid back shave removal basal cell c...   
    ..                                                 ...   
    477                                         discussion   
    478  a duodenum biopsy duodenal mucosa with foveola...   
    479  bladder tumor transurethral resection poorly d...   
    480  sigmoid colon polypectomy tubular adenoma and ...   
    481  skin distal right shaft of penis snip invasive...   
    
                                                DISCUSSION  \
    0    this case has been reviewed by drs yan and lin...   
    1                                                  NaN   
    2                                                  NaN   
    3    the underlying etiology of the clinical pigmen...   
    4                                                  NaN   
    ..                                                 ...   
    477                                                NaN   
    478                                                NaN   
    479  the tumor demonstrates small nests and discohe...   
    480                                                NaN   
    481  consensus diagnosis was established among derm...   
    
                                        ADDITIONAL STUDIES ADDENDUM DISCUSSION  \
    0                                                  NaN                 NaN   
    1                                                  NaN                 NaN   
    2                                                  NaN                 NaN   
    3    immunohistochemistry studies formalin fixed pa...                 NaN   
    4                                                  NaN                 NaN   
    ..                                                 ...                 ...   
    477                                                NaN                 NaN   
    478                                                NaN                 NaN   
    479  immunohistochemistry studies formalin fixed pa...                 NaN   
    480                                                NaN                 NaN   
    481  multiple step leveled sections are reviewed me...                 NaN   
    
        RESULTS INTERPRETATION FROZEN SECTION FINAL DIAGNOSIS  \
    0       NaN            NaN            NaN             NaN   
    1       NaN            NaN            NaN             NaN   
    2       NaN            NaN            NaN             NaN   
    3       NaN            NaN            NaN             NaN   
    4       NaN            NaN            NaN             NaN   
    ..      ...            ...            ...             ...   
    477     NaN            NaN            NaN             NaN   
    478     NaN            NaN            NaN             NaN   
    479     NaN            NaN            NaN             NaN   
    480     NaN            NaN            NaN             NaN   
    481     NaN            NaN            NaN             NaN   
    
        FROZEN SECTION DIAGNOSIS  
    0                        NaN  
    1                        NaN  
    2                        NaN  
    3                        NaN  
    4                        NaN  
    ..                       ...  
    477                      NaN  
    478                      NaN  
    479                      NaN  
    480                      NaN  
    481                      NaN  
    
    [93039 rows x 11 columns]


That's basically everything.
